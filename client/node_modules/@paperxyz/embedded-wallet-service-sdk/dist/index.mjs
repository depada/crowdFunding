var Q=Object.defineProperty,F=Object.defineProperties;var H=Object.getOwnPropertyDescriptors;var b=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,V=Object.prototype.propertyIsEnumerable;var N=(a,e,t)=>e in a?Q(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,u=(a,e)=>{for(var t in e||(e={}))z.call(e,t)&&N(a,t,e[t]);if(b)for(var t of b(e))V.call(e,t)&&N(a,t,e[t]);return a},E=(a,e)=>F(a,H(e));var i=(a,e,t)=>new Promise((r,s)=>{var n=l=>{try{d(t.next(l))}catch(p){s(p)}},o=l=>{try{d(t.throw(l))}catch(p){s(p)}},d=l=>l.done?r(l.value):Promise.resolve(l.value).then(n,o);d((t=t.apply(a,e)).next())});var y="/sdk/2022-08-12/embedded-wallet",A=a=>`paperEwsWalletUserId-${a}`,j="walletToken",L=a=>`${j}-${a}`,P="a",f=(a,e)=>`${P}-${a}-${e}`,re=a=>`${P}-${a}`;var q=(n=>(n.PAPER_EMAIL_OTP="PaperEmailOTP",n.GOOGLE="Google",n.TWITTER="Twitter",n.AUTH0="Auth0",n.CUSTOM_JWT="CustomJWT",n))(q||{});var G=(t=>(t.LOGGED_OUT="Logged Out",t.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",t))(G||{}),R=(s=>(s.LOGGED_OUT="Logged Out",s.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",s.LOGGED_IN_NEW_DEVICE="Logged In, New Device",s.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",s))(R||{});import{getPaperOriginUrl as $}from"@paperxyz/sdk-common-utilities";var x=new Map,m=class{constructor({clientId:e}){this.isSupported=typeof window!="undefined"&&!!window.localStorage,this.clientId=e}getItem(e){return i(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=x.get(e))!=null?t:null})}setItem(e,t){return i(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);x.set(e,t)})}removeItem(e){return i(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return i(this,null,function*(){yield this.setItem(L(this.clientId),e)})}getAuthCookie(){return i(this,null,function*(){return this.getItem(L(this.clientId))})}removeAuthCookie(){return i(this,null,function*(){return this.removeItem(L(this.clientId))})}saveDeviceShare(e,t){return i(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(f(this.clientId,t),e)})}getDeviceShare(){return i(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(f(this.clientId,e)):null})}removeDeviceShare(){return i(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(f(this.clientId,e)):!1})}getWalletUserId(){return i(this,null,function*(){return this.getItem(A(this.clientId))})}saveWalletUserId(e){return i(this,null,function*(){yield this.setItem(A(this.clientId),e)})}removeWalletUserId(){return i(this,null,function*(){return this.removeItem(A(this.clientId))})}};import{getPaperOriginUrl as W}from"@paperxyz/sdk-common-utilities";function C(a){return new Promise(e=>{setTimeout(e,a*1e3)})}var Z={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},v=new Map,_=class{constructor({link:e,iframeId:t,container:r=document.body,iframeStyles:s,onIframeInitialize:n}){this.POLLING_INTERVAL_SECONDS=1.4;this.POST_LOAD_BUFFER_SECONDS=1;let o=document.getElementById(t),d=new URL(e),l="1.0.1";if(!l)throw new Error("Missing SDK_VERSION env var");if(d.searchParams.set("sdkVersion",l),!o||o.src!=d.href){if(!o){o=document.createElement("iframe");let p=u(u({},Z),s);Object.assign(o.style,p),o.setAttribute("id",t),r.appendChild(o)}o.src=d.href,o.setAttribute("data-version",l),o.onload=this.onIframeLoadHandler(o,this.POST_LOAD_BUFFER_SECONDS,n)}this.iframe=o}onIframeLoadedInitVariables(){return i(this,null,function*(){return{}})}onIframeLoadHandler(e,t,r){return()=>i(this,null,function*(){yield new Promise((n,o)=>i(this,null,function*(){var p;let d=new MessageChannel;d.port1.onmessage=T=>{let{data:h}=T;return d.port1.close(),h.success?(v.set(e.src,!0),r&&r(),n(!0)):o(new Error(h.error))},yield C(t);let l="initIframe";(p=e==null?void 0:e.contentWindow)==null||p.postMessage({eventType:l,data:yield this.onIframeLoadedInitVariables()},`${W()}${y}`,[d.port2])}))})}call(n){return i(this,arguments,function*({procedureName:e,params:t,showIframe:r=!1,injectRecoveryCode:s={isInjectRecoveryCode:!1}}){for(;!v.get(this.iframe.src);)yield C(this.POLLING_INTERVAL_SECONDS);return r&&(this.iframe.style.display="block",yield C(.005)),new Promise((d,l)=>{var T;if(s.isInjectRecoveryCode){let h=c=>i(this,null,function*(){var O,U;if(c.origin!==W()||c.data.type!=="paper_getRecoveryCode"||typeof c.data.userWalletId!="string")return;let k=yield(O=s.getRecoveryCode)==null?void 0:O.call(s,c.data.userWalletId);(U=this.iframe.contentWindow)==null||U.postMessage({type:"paper_getRecoveryCode_response",recoveryCode:k},W()),window.removeEventListener("message",h)});window.addEventListener("message",h)}let p=new MessageChannel;p.port1.onmessage=h=>i(this,null,function*(){let{data:c}=h;p.port1.close(),r&&(yield C(.1),this.iframe.style.display="none"),c.success?d(c.data):l(new Error(c.error))}),(T=this.iframe.contentWindow)==null||T.postMessage({eventType:e,data:t},`${W()}${y}`,[p.port2])})})}destroy(){v.delete(this.iframe.src)}};var w=class extends _{constructor({clientId:t,customizationOptions:r}){super({iframeId:J,link:B({clientId:t,path:y,queryParams:r}).href,container:document.body});this.clientId=t}onIframeLoadedInitVariables(){return i(this,null,function*(){let t=new m({clientId:this.clientId});return{authCookie:yield t.getAuthCookie(),deviceShareStored:yield t.getDeviceShare(),walletUserId:yield t.getWalletUserId(),clientId:this.clientId}})}};function B({clientId:a,path:e,queryParams:t}){var s;let r=new URL(e,$());if(t)for(let n of Object.keys(t))r.searchParams.set(n,((s=t[n])==null?void 0:s.toString())||"");return r.searchParams.set("clientId",a),r}var J="paper-embedded-wallet-iframe";var D=class{constructor({clientId:e,querier:t,onAuthSuccess:r}){this.clientId=e,this.AuthQuerier=t,this.localStorage=new m({clientId:e}),this.onAuthSuccess=r}preLogin(){return i(this,null,function*(){yield this.logout()})}postLogin(r){return i(this,arguments,function*({storedToken:e,walletDetails:t}){return e.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(e.cookieString)),yield this.onAuthSuccess({storedToken:e,walletDetails:t})})}loginWithJwtAuth(s){return i(this,arguments,function*({token:e,authProvider:t,recoveryCode:r}){yield this.preLogin();let n=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:e,authProvider:t,recoveryCode:r}});return this.postLogin(n)})}loginWithPaperModal(e){return i(this,null,function*(){yield this.preLogin();let t=yield this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0,getRecoveryCode:e==null?void 0:e.getRecoveryCode}});return this.postLogin(t)})}loginWithPaperEmailOtp(r){return i(this,arguments,function*({email:e,recoveryCode:t}){yield this.preLogin();let s=yield this.AuthQuerier.call({procedureName:"loginWithPaperModal",params:{email:e,recoveryCode:t},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(s)})}sendPaperEmailLoginOtp(t){return i(this,arguments,function*({email:e}){yield this.preLogin();let{isNewUser:r,isNewDevice:s}=yield this.AuthQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:e}});return{isNewUser:r,isNewDevice:s}})}verifyPaperEmailLoginOtp(s){return i(this,arguments,function*({email:e,otp:t,recoveryCode:r}){let n=yield this.AuthQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:e,otp:t,recoveryCode:r},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(n)})}logout(){return i(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),r=yield this.localStorage.removeWalletUserId();return{success:e||t||r}})}};import{getDefaultProvider as Y}from"@ethersproject/providers";import{ChainToPublicRpc as ee}from"@paperxyz/sdk-common-utilities";var I=class{constructor({chain:e,clientId:t,querier:r}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=r}callContract(s){return i(this,arguments,function*({contractAddress:e,methodArgs:t,methodInterface:r}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:e,method:{args:t,stub:r}}})})}};import{Signer as K}from"@ethersproject/abstract-signer";import{defineReadOnly as X}from"@ethersproject/properties";var g=class extends K{constructor({provider:t,clientId:r,querier:s}){var n;super();this.DEFAULT_ETHEREUM_CHAIN_ID=5;this.clientId=r,this.querier=s,this.endpoint=(n=t.connection)==null?void 0:n.url,X(this,"provider",t)}getAddress(){return i(this,null,function*(){let{address:t}=yield this.querier.call({procedureName:"getAddress",params:void 0});return t})}signMessage(t){return i(this,null,function*(){var n,o,d,l;let r=yield(n=this.provider)==null?void 0:n.getNetwork();r&&r._defaultProvider;let{signedMessage:s}=yield this.querier.call({procedureName:"signMessage",params:{message:t,chainId:(l=(d=yield(o=this.provider)==null?void 0:o.getNetwork())==null?void 0:d.chainId)!=null?l:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return s})}signTransaction(t){return i(this,null,function*(){var s,n,o;let{signedTransaction:r}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:t,chainId:(o=(n=yield(s=this.provider)==null?void 0:s.getNetwork())==null?void 0:n.chainId)!=null?o:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return r})}_signTypedData(t,r,s){return i(this,null,function*(){var o,d,l;let{signedTypedData:n}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:t,types:r,message:s,chainId:(l=(d=yield(o=this.provider)==null?void 0:o.getNetwork())==null?void 0:d.chainId)!=null?l:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return n})}connect(t){return new g({clientId:this.clientId,provider:t,querier:this.querier})}};var S=class{constructor({clientId:e,chain:t,querier:r}){this.clientId=e,this.chain=t,this.walletManagerQuerier=r,this.gasless=new I({chain:t,clientId:e,querier:r}),this.localStorage=new m({clientId:e})}postWalletSetUp(n){return i(this,arguments,function*({deviceShareStored:e,walletAddress:t,isIframeStorageEnabled:r,walletUserId:s}){return r||(yield this.localStorage.saveDeviceShare(e,s)),{walletAddress:t}})}getUserWalletStatus(){return i(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:E(u({},e.user),{wallet:this})}:e})}setChain(t){return i(this,arguments,function*({chain:e}){this.chain=e,this.gasless=new I({chain:e,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return i(this,null,function*(){var r;return new g({clientId:this.clientId,provider:Y((r=e==null?void 0:e.rpcEndpoint)!=null?r:ee[this.chain]),querier:this.walletManagerQuerier})})}};var M=class{constructor({clientId:e,chain:t,styles:r}){this.clientId=e,this.querier=new w({clientId:e,customizationOptions:r}),this.wallet=new S({clientId:e,chain:t,querier:this.querier}),this.auth=new D({clientId:e,querier:this.querier,onAuthSuccess:s=>i(this,null,function*(){return yield this.wallet.postWalletSetUp(E(u({},s.walletDetails),{walletUserId:s.storedToken.authDetails.userWalletId})),{user:{status:"Logged In, Wallet Initialized",authDetails:s.storedToken.authDetails,wallet:this.wallet,walletAddress:s.walletDetails.walletAddress}}})})}getUser(){return i(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return u({status:"Logged In, Wallet Initialized"},e.user)}})}};export{L as AUTH_TOKEN_LOCAL_STORAGE_NAME,q as AuthProvider,f as DEVICE_SHARE_LOCAL_STORAGE_NAME,re as DEVICE_SHARE_LOCAL_STORAGE_NAME_DEPRECATED,y as EMBEDDED_WALLET_PATH,M as PaperEmbeddedWalletSdk,G as UserStatus,R as UserWalletStatus,A as WALLET_USER_ID_LOCAL_STORAGE_NAME};
//# sourceMappingURL=index.mjs.map